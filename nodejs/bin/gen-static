#!/bin/bash
# -*- coding: utf-8 -*-
#
# jomiel-proto
#
# Copyright
#  2020-2021 Toni Gündoğdu
#
#
# SPDX-License-Identifier: Apache-2.0
#

# gen-static
#
# A simple script to compile protobuf declarations for jomiel messages
# into a single static module using pbjs.
#
set -e;

# Enable bash globstar for recursive search ("**/*.proto").
#
shopt -s globstar

# The location of the protobuf declaration (.proto) files.
#
PROTODIR=

# The path to the pbjs command.
#
PBJS=./node_modules/protobufjs/bin/pbjs

# The destination module file to produce.
#
OUTFILE=src/compiled.js

# PBJS: Specifies the wrapper to use.
PBJS_WRAP=commonjs

# Extra options for pbjs.
PBJS_EXTRAOPTS="--no-verify --no-convert --no-delimited"
PBJS_EXTRAOPTS="$PBJS_EXTRAOPTS --no-beautify --no-comments"

help()
{
    cat <<EOF
Usage: ${0##*/} [-e] [-j <pbjspath>] [-p <protodir>] [-o <outfile>]

Notes
    - Make sure you have installed protobufjs first

Where
    -e  enable the ES6 support in the compiled static library; implies
    (for example) ECMAScript modules (ESM) support which nodejs supports
    as of 13.2.0 (without a flag).

    <protodir> path to the root dir containing the .proto files to
        compile

    <outfile> is the destination module file to produce (default:
        $OUTFILE)

    <pbjspath> is the path to the pbjs command
        (default: $PBJS)


EOF
    [ -n "$1" ] && echo "error: $1"
    exit 0
}

compile_files()
{
    OPTS="-t static-module -w $PBJS_WRAP $PBJS_EXTRAOPTS"
    PROTO_FILES=$PROTODIR/**/*.proto

    echo -n "Compiling the protobuf declarations for jomiel messages..."
    $PBJS $OPTS -o $OUTFILE $PROTO_FILES || exit $?
    echo "done."

    exit 0
}

while getopts "?hep:o:j:" o; do
case "$o" in
    e) PBJS_WRAP=es6 ;;
    p) PROTODIR=$OPTARG ;;
    o) OUTFILE=$OPTARG ;;
    j) PBJS=$OPTARG ;;
    h|?) help ;;
esac
done

shift $((OPTIND-1)) # Shift off the options and optional --

[ -z "$PROTODIR" ] && help "-p <protodir> not specified"
[ -z "$OUTFILE" ] && help "-o <outfile> not specified"
compile_files

exit $?
