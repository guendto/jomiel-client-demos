#!/bin/sh
# -*- coding: utf-8 -*-
#
# jomiel-examples
#
# Copyright
#  2019 Toni Gündoğdu
#
#
# SPDX-License-Identifier: Apache-2.0
#

# Protobuffer compiler
#
PROTOC=`which protoc`
[ -z "$PROTOC" ] && {
    echo "protoc: command not found"
    exit 1
}

# Save generated files to this directory.
#
DESTDIR=

# The location of the protobuf declaration (.proto) files.
#
PROTODIR=

# The language bindings ID to use (e.g. go or python)

help()
{
    cat <<EOF
usage: ${0##*/} [-p <protodir>] [-l <langid>] [-d <destdir>]

where <protodir> path to a dir containing the .proto files to compile

      <langid> is the language binding (e.g. "go", "python"), must be
        supported by protoc(1), note that if "c" is used, protoc-c(1)
        of protobuf-c needs to be found in the path

      <destdir> is the destination for the compiled protobuf messages

EOF
    [ -n "$1" ] && echo "error: $1"
    exit 0
}

compile_files()
{
    echo -n "Compiling the protobuf declarations for jomiel messages"
    for f in $PROTODIR/*.proto; do
        $PROTOC -I$PROTODIR --"$LANGID"_out=$DESTDIR $f || exit $?
        echo -n "."
    done
    echo "done."
    exit 0
}

while getopts "?hd:p:l:" o; do
case "$o" in
    p) PROTODIR=$OPTARG ;;
    d) DESTDIR=$OPTARG ;;
    l) LANGID=$OPTARG ;;
    h|?) help ;;
esac
done

shift $((OPTIND-1)) # Shift off the options and optional --

[ -z "$PROTODIR" ] && help "-p <protodir> not specified"
[ -z "$DESTDIR" ] && help "-d <destdir> not specified"
[ -z "$LANGID" ] && help "-l <langid> not specified"

[ "$LANGID" = "c" ] && PROTOC=protoc-c

[ -d "$DESTDIR" ] || mkdir -p "$DESTDIR"
compile_files

# vim: set ts=4 sw=4 tw=72 expandtab:
